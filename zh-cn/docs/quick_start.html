<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="quick_start" />
	<meta name="description" content="quick_start" />
	<!-- 网页标签标题 -->
	<title>quick_start</title>
	<link rel="shortcut icon" href="/img/apache.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><a href="//www.apache.org"><img class="logo apache" style="width:120px" src="/img/asf_logo.svg"/></a><div class="logo-split"></div><a href=""></a><img class="logo tube" style="width:72px" src="/img/Tube logo.svg"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><div><ul class="ant-menu blackClass ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/docs/quick_start.html" target="_self">文档</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/docs/development/how-to-contribute.html" target="_self">开发</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/apache/incubator-tubemq" target="_self">GITHUB</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper">Apache</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul></div></div></div><div class="header-background"></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>引导</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/quick_start.html" target="_self">快速开始</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/producer_example.html" target="_self">生产者示例</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/consumer_example.html" target="_self">消费者示例</a></li></ul></li><li class="menu-item menu-item-level-1"><span>架构及原理</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/architecture.html" target="_self">架构介绍</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/client_rpc.html" target="_self">客户端RPC</a></li></ul></li><li class="menu-item menu-item-level-1"><span>用户手册</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/deployment.html" target="_self">部署指引</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/configure_introduction.html" target="_self">配置参数介绍</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/console_introduction.html" target="_self">管控台操作指引</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/error_code.html" target="_self">错误码</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>API介绍<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/http_access_api.html" target="_self">HTTP API介绍</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/clients_java.html" target="_self">JAVA SDK API介绍</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span><div class="menu-item menu-item-level-1" style="margin-left:-20px"><a href="/zh-cn/docs/contact.html" target="_self" style="padding-left:20px">联系我们</a></div></span><ul></ul></li></ul></div><div class="doc-content markdown-body"><h2>准备工作</h2>
<ul>
<li>Java 1.7 或 1.8(Java 9 及以上，未经测试验证)</li>
<li>Maven 3.* 及以上</li>
</ul>
<h2>构建</h2>
<h3>从下载的发行版代码包构建</h3>
<p>在TubeMQ根目录下执行命令：</p>
<pre><code class="language-bash">mvn clean package -DskipTests
</code></pre>
<p>在根目录执行 <code>mvn clean install</code> 之后，可以单独对每个 module 进行构建。</p>
<h3>基于源代码构建</h3>
<p>在IDE中构建和调试源码，需要先运行以下命令：</p>
<pre><code class="language-bash">mvn compile
</code></pre>
<p>执行之后，会生成 <code>protoc</code> 文件对应的 java source file，位于 <code>target/generated-sources</code> 目录。</p>
<p>然后就可以在 IDE 中打开 TubeMQ 工程。</p>
<p>你可以跳到 下一章 部署运行 ， 除非你准备自己编译proto 文件。（通常不需要，mvn会自动下载protoc 构建)。</p>
<p>如果你打算使用本地的 <code>protoc</code> 可执行文件，你可以修改 <code>tubemq-core/pom.xml</code> 下的 <code>protobuf-maven-plugin</code> 的配置，如下所示。</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">outputDirectory</span>&gt;</span>${project.build.directory}/generated-sources/java<span class="hljs-tag">&lt;/<span class="hljs-name">outputDirectory</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">protocExecutable</span>&gt;</span>/usr/local/bin/protoc<span class="hljs-tag">&lt;/<span class="hljs-name">protocExecutable</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2>部署运行</h2>
<p>构建完成之后，在 <code>tubemq-server/target</code> 目录下会有 <strong>tubemq-server-x.x.x-bin.tar.gz</strong> 文件.
这是 Server 的部署包，包含了脚本、配置文件、依赖以及 web GUI相关的内容。</p>
<p>首次部署，只需要解压部署包，解压之后的目录结构如下：</p>
<pre><code>/opt/tubemq-server
├── bin
├── conf
├── lib
├── logs
└── resources
</code></pre>
<h3>配置</h3>
<p>TubeMQ 集群有两个角色: <strong>Master</strong> 和 <strong>Broker</strong>. Master 和 Broker 可以部署在相同或者不同的节点上。下面是
一个集群的配置示例：</p>
<table>
<thead>
<tr>
<th>Role</th>
<th>TCP Port</th>
<th>TLS Port</th>
<th>Web Port</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>8099</td>
<td>8199</td>
<td>8080</td>
<td>元数据存储在 /stage/metadata</td>
</tr>
<tr>
<td>Broker</td>
<td>8123</td>
<td>8124</td>
<td>8081</td>
<td>消息存储在 /stage/msgdata</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>2181</td>
<td></td>
<td></td>
<td>Offset 存储在 /tubemq</td>
</tr>
</tbody>
</table>
<p>详细的配置信息如下所示，注意将 <code>YOUR_SERVER_IP</code> 替换为真实的IP。</p>
<h4>master.ini</h4>
<pre><code class="language-ini"><span class="hljs-section">[master]</span>
<span class="hljs-attr">hostName</span>=YOUR_SERVER_IP
<span class="hljs-attr">port</span>=<span class="hljs-number">8000</span>
<span class="hljs-attr">webPort</span>=<span class="hljs-number">8080</span>
<span class="hljs-attr">consumerBalancePeriodMs</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">firstBalanceDelayAfterStartMs</span>=<span class="hljs-number">60000</span>
<span class="hljs-attr">consumerHeartbeatTimeoutMs</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">producerHeartbeatTimeoutMs</span>=<span class="hljs-number">45000</span>
<span class="hljs-attr">brokerHeartbeatTimeoutMs</span>=<span class="hljs-number">25000</span>
<span class="hljs-attr">confModAuthToken</span>=abc
<span class="hljs-attr">webResourcePath</span>=/opt/tubemq-server/resources

<span class="hljs-section">[zookeeper]</span>
<span class="hljs-attr">zkNodeRoot</span>=/tubemq
<span class="hljs-attr">zkServerAddr</span>=localhost:<span class="hljs-number">2181</span>
<span class="hljs-attr">zkSessionTimeoutMs</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">zkConnectionTimeoutMs</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">zkSyncTimeMs</span>=<span class="hljs-number">5000</span>
<span class="hljs-attr">zkCommitPeriodMs</span>=<span class="hljs-number">5000</span>

<span class="hljs-section">[replication]</span>
<span class="hljs-comment">; name of current node; MUST BE DIFFERENT for every node in the cluster</span>
<span class="hljs-attr">repNodeName</span>=tubemqMasterGroupNode1
<span class="hljs-comment">; helperHost(and port) for nodes to join master cluster</span>
<span class="hljs-attr">repHelperHost</span>=YOUR_SERVER_IP:<span class="hljs-number">9001</span>
</code></pre>
<h5>resources/velocity.properties</h5>
<pre><code class="language-properties"><span class="hljs-meta">resource.loader</span>=<span class="hljs-string">file</span>
<span class="hljs-meta">file.resource.loader.description</span>=<span class="hljs-string">Velocity File Resource Loader</span>
<span class="hljs-meta">file.resource.loader.class</span>=<span class="hljs-string">org.apache.velocity.runtime.resource.loader.FileResourceLoader</span>
<span class="hljs-meta">file.resource.loader.path</span>=<span class="hljs-string">/opt/tubemq-server/resources/templates</span>
<span class="hljs-meta">file.resource.loader.cache</span>=<span class="hljs-string">false</span>
<span class="hljs-meta">file.resource.loader.modificationCheckInterval</span>=<span class="hljs-string">2</span>
<span class="hljs-meta">string.resource.loader.description</span>=<span class="hljs-string">Velocity String Resource Loader</span>
<span class="hljs-meta">string.resource.loader.class</span>=<span class="hljs-string">org.apache.velocity.runtime.resource.loader.StringResourceLoader</span>
<span class="hljs-meta">input.encoding</span>=<span class="hljs-string">UTF-8</span>
<span class="hljs-meta">output.encoding</span>=<span class="hljs-string">UTF-8</span>
</code></pre>
<h5>conf/broker.ini</h5>
<pre><code class="language-ini"><span class="hljs-section">[broker]</span>
<span class="hljs-attr">brokerId</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">hostName</span>=YOUR_SERVER_IP
<span class="hljs-attr">port</span>=<span class="hljs-number">8123</span>
<span class="hljs-attr">webPort</span>=<span class="hljs-number">8081</span>
<span class="hljs-attr">masterAddressList</span>=YOUR_SERVER_IP:<span class="hljs-number">8000</span>
<span class="hljs-attr">primaryPath</span>=/stage/msgdata
<span class="hljs-attr">maxSegmentSize</span>=<span class="hljs-number">1073741824</span>
<span class="hljs-attr">maxIndexSegmentSize</span>=<span class="hljs-number">22020096</span>
<span class="hljs-attr">transferSize</span>= <span class="hljs-number">524288</span>
<span class="hljs-attr">loadMessageStoresInParallel</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">consumerRegTimeoutMs</span>=<span class="hljs-number">35000</span>

<span class="hljs-section">[zookeeper]</span>
<span class="hljs-attr">zkNodeRoot</span>=/tubemq
<span class="hljs-attr">zkServerAddr</span>=localhost:<span class="hljs-number">2181</span>
<span class="hljs-attr">zkSessionTimeoutMs</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">zkConnectionTimeoutMs</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">zkSyncTimeMs</span>=<span class="hljs-number">5000</span>
<span class="hljs-attr">zkCommitPeriodMs</span>=<span class="hljs-number">5000</span>
<span class="hljs-attr">zkCommitFailRetries</span>=<span class="hljs-number">10</span>

</code></pre>
<p>特别的，对于 Master 节点，需要在 <code>/etc/hosts</code> 中配置其他 Master 节点的信息，如果 Master 节点的IP地址为<code>192.168.1.2</code>：</p>
<pre><code>192.168.1.2 192-168-1-2
</code></pre>
<h2>高可用性介紹</h2>
<p>在上面的例子中，我们在单个节点上运行服务。然而，在实际的生产环境中，
你需要在不同的服务器上运行多个 Master 服务以达到高可用性的目的。
下面是可用性级别的介绍：</p>
<table>
<thead>
<tr>
<th>HA级别</th>
<th>Master数量</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>高</td>
<td>3 masters</td>
<td>任何主节点崩溃后，集群元数据仍处于读/写状态，可以接受新的生产者/消费者。</td>
</tr>
<tr>
<td>中</td>
<td>2 masters</td>
<td>一个主节点崩溃后，集群元数据处于只读状态。对现有的生产者和消费者没有任何影响。</td>
</tr>
<tr>
<td>低</td>
<td>1 master</td>
<td>主节点崩溃后，对现有的生产者和消费者没有影响。</td>
</tr>
</tbody>
</table>
<p>请注意，主服务器的时钟应该是同步的。</p>
<h2>启动集群</h2>
<p>配置完成之后，就可以按照以下步骤启动集群。</p>
<h3>启动主节点</h3>
<p>完成如上配置设置后，首先进入主备Master所在的TubeMQ环境的 <code>bin</code> 目录，进行服务启动操作。</p>
<pre><code class="language-bash">./tubemq master start
</code></pre>
<p>访问Master的管控台 <code>http://your-master-ip:8080</code> ，页面可查则表示 master 已成功启动。</p>
<p><img src="img/tubemq-console-gui.png" alt="TubeMQ Console GUI"></p>
<h2>启动代理</h2>
<p>Broker启动前，首先要在Master上配置Broker元数据，增加Broker相关的管理信息。</p>
<p>在<code>Broker List</code> 页面,  <code>Add Single Broker</code>，然后填写相关信息。</p>
<p><img src="img/tubemq-add-broker-1.png" alt="Add Broker 1"></p>
<p>需要填写的内容包括：</p>
<ol>
<li>broker IP: broker server ip</li>
<li>authToken:  <code>conf/master.ini</code> 文件中 <code>confModAuthToken</code> 字段配置的 token</li>
</ol>
<p>然后上线Broker：</p>
<p><img src="img/tubemq-add-broker-2.png" alt="Add Broker 2"></p>
<p>到 Broker 节点的 <code>bin</code> 目录下，执行以下命令启动 Broker服务：</p>
<pre><code class="language-bash">./tubemq broker start
</code></pre>
<p>刷新页面可以看到 Broker 已经注册，当 <code>当前运行子状态</code> 为 <code>idle</code> 时， 可以增加topic。</p>
<p><img src="img/tubemq-add-broker-3.png" alt="Add Broker 3"></p>
<h2>新增 Topic</h2>
<p>可以通过 web GUI 添加 Topic， 在 <code>Topic列表</code>页面添加，需要填写相关信息</p>
<p><img src="img/tubemq-add-topic-1.png" alt="Add Topic 1"></p>
<p>然后选择部署 Topic 的 Broker</p>
<p><img src="img/tubemq-add-topic-5.png" alt="Add Topic 5"></p>
<p>此时 Broker的 <code>可发布</code> 和 <code>可订阅</code> 依旧是灰色的</p>
<p><img src="img/tubemq-add-topic-6.png" alt="Add Topic 6"></p>
<p>需要在 <code>Broker列表</code>页面重载Broker 配置</p>
<p><img src="img/tubemq-add-topic-2.png" alt="Add Topic 2"></p>
<p><img src="img/tubemq-add-topic-3.png" alt="Add Topic 3"></p>
<p>之后就可以在页面查看Topic信息。</p>
<p><img src="img/tubemq-add-topic-4.png" alt="Add Topic 4"></p>
<h2>运行示例</h2>
<p>可以使用 Example 来测试集群。首先，我们运行 producer的demo，注意将 <code>YOUR_SERVER_IP</code> 替换为实际的IP（例如：localhost）</p>
<pre><code class="language-bash">java -Dlog4j.configuration=file:/opt/tubemq-server/conf/tools.log4j.properties  \
-Djava.net.preferIPv4Stack=<span class="hljs-literal">true</span> -cp  /opt/tubemq-server/lib/*:/opt/tubemq-server/conf/* \
org.apache.tubemq.example.MessageProducerExample \
YOUR_SERVER_IP:8000 demo 10000000
</code></pre>
<p>从日志我们可以看到，数据发送成功</p>
<pre><code class="language-bash">[2020-06-04 11:19:04,405] INFO Send demo 1000 message, keyCount is 252 (org.apache.tubemq.example.MessageProducerExample)
[2020-06-04 11:19:04,652] INFO Send demo 2000 message, keyCount is 502 (org.apache.tubemq.example.MessageProducerExample)
[2020-06-04 11:19:05,096] INFO Send demo 3000 message, keyCount is 752 (org.apache.tubemq.example.MessageProducerExample)
[2020-06-04 11:19:05,181] INFO Send demo 4000 message, keyCount is 1002 (org.apache.tubemq.example.MessageProducerExample)
</code></pre>
<p>然后运行 consume 的 demo，<code>YOUR_SERVER_IP</code> 也需要替换（例如： localhost）</p>
<pre><code class="language-bash">java -Xmx512m -Dlog4j.configuration=file:/opt/tubemq-server/conf/tools.log4j.properties \
-Djava.net.preferIPv4Stack=<span class="hljs-literal">true</span> -cp /opt/tubemq-server/lib/*:/opt/tubemq-server/conf/* \
org.apache.tubemq.example.MessageConsumerExample \
YOUR_SERVER_IP:8000 demo demoGroup 3 1 1
</code></pre>
<p>从日志我们可以看到，数据被消费者消费到</p>
<pre><code class="language-bash">[2020-06-04 11:20:29,107] INFO Receive messages:270000 (org.apache.tubemq.example.MsgRecvStats)
[2020-06-04 11:20:31,206] INFO Receive messages:272500 (org.apache.tubemq.example.MsgRecvStats)
[2020-06-04 11:20:31,590] INFO Receive messages:275000 (org.apache.tubemq.example.MsgRecvStats)
[2020-06-04 11:20:31,910] INFO Receive messages:277500 (org.apache.tubemq.example.MsgRecvStats)
</code></pre>
<hr>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/incubator-logo.svg"/><div class="cols-container"><div class="col col-24"><p>Apache TubeMQ (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></div><div class="copyright"><span>Copyright © 2019-2020 The Apache Software Foundation. Apache TubeMQ, TubeMQ, and its feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script src="https://buttons.github.io/buttons.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>
